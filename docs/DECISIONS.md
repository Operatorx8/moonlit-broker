# DECISIONS - 决策日志 (ADR Lite)

> 记录"为什么这么做"，避免以后推翻自己还说不清

---

## ADR-001: 效果系统采用配置驱动架构

**日期**：2025-02-04

**决策**：盔甲效果参数通过配置定义，不在物品类硬编码

**原因**：
- 便于数值调整，无需改代码
- 支持热重载（未来）
- 减少代码重复，5 件头盔共享判定逻辑

**备选方案**：
- 每件装备各自实现完整逻辑 → 代码重复严重，维护成本高

**影响范围**：
- `EffectConfig` 结构体设计
- 所有头盔的效果实现
- 日志输出格式

---

## ADR-002: 使用固定 UUID 的 AttributeModifier

**日期**：2025-02-04

**决策**：所有动态属性修改器使用预定义的固定 UUID

**原因**：
- 避免属性叠加 bug（多次添加不同 UUID 的 modifier）
- 覆盖式更新：同一 UUID 只存在一个 modifier
- 便于追踪和移除

**备选方案**：
- 每次 tick 先移除再添加 → 有短暂无属性的帧，可能导致 bug

**影响范围**：
- `ExileMaskEffect`（低血增伤）
- 未来所有动态属性效果
- 需维护 UUID 常量文件

**UUID 分配**：
```java
// ModUUIDs.java
public static final UUID EXILE_MASK_DAMAGE = UUID.fromString("a1b2c3d4-...");
```

---

## ADR-003: 冷却使用统一 CooldownManager

**日期**：2025-02-04

**决策**：所有冷却由 `CooldownManager` 单例管理，不在各效果类内部维护

**原因**：
- 统一的冷却存储和查询接口
- 便于序列化/持久化（未来）
- 日志输出格式统一

**备选方案**：
- 各效果自己管理冷却 → 代码重复，格式不一致

**影响范围**：
- 所有带冷却的效果
- 日志输出（`cd_total`, `cd_left`, `cd_key`）

---

## ADR-004: 日志分级策略

**日期**：2025-02-04

**决策**：采用 INFO/TRACE/WARN 三级，默认只输出 INFO

**原因**：
- INFO 足以验收功能是否正常
- TRACE 仅调试时开启，避免日志爆炸
- WARN 提醒问题但不中断游戏

**备选方案**：
- 全部 DEBUG 级 → 日志过多，难以定位关键事件

**影响范围**：
- `ModLogger` 实现
- 所有效果的日志调用

---

## ADR-005: 回溯者额饰不覆盖图腾机制

**日期**：2025-02-04

**决策**：当玩家持有不死图腾时，优先触发图腾，额饰不触发

**原因**：
- 尊重原版机制，不破坏玩家预期
- 避免"双保险"过于强力
- 图腾有明确的视觉/音效反馈，玩家更熟悉

**备选方案**：
- 额饰优先 → 玩家可能困惑为什么图腾没用
- 两者都触发 → 太强，失去平衡

**影响范围**：
- `RetracerOrnamentEffect` 触发判定
- 需检测玩家主副手物品

---

## ADR-006: 遗世之环采用边沿触发而非电平触发

**日期**：2025-02-04

**决策**：仅在怪物"首次锁定玩家"时触发，持续锁定不重复触发

**原因**：
- 边沿触发（edge-triggered）更符合"被盯上"的瞬间感
- 避免持续战斗中不断触发导致效果过强
- 更有策略性：玩家可以通过脱离战斗重置触发条件

**备选方案**：
- 电平触发（level-triggered）：只要有怪物锁定就触发 → 效果过强
- 定时触发：每 N 秒检测一次 → 失去"被盯上"的即时反馈

**影响范围**：
- `RelicCircletEffect` 需要追踪怪物的 target 状态变化
- 需要维护"已触发过的怪物列表"或类似机制

---

## ADR-007: 低频扫描策略（哨兵瞭望、流亡面甲）

**日期**：2025-02-04

**决策**：非即时触发的效果采用 20 ticks（1 秒）扫描周期

**原因**：
- 平衡性能与响应速度
- 1 秒延迟对游戏体验影响可接受
- 避免每 tick 做昂贵的实体扫描/属性计算

**备选方案**：
- 每 tick 检测 → 性能开销大
- 每 40 ticks → 响应太慢，体验差

**影响范围**：
- `SentinelEffect`（黑暗检测 + 范围扫描）
- `ExileMaskEffect`（血量监听 + 属性更新）

---

## ADR-008: 沉默之誓约仅对怪物伤害生效

**日期**：2025-02-04

**决策**：减伤效果仅对敌对生物（hostile mob）造成的伤害生效

**原因**：
- 设计定位是"对抗怪物"的装备
- 避免被用于 PVP 场景（如需 PVP 另做平衡）
- 避免对环境伤害（摔落、熔岩）生效导致过强

**备选方案**：
- 对所有伤害生效 → 太强，变成万能减伤
- 仅对近战生效 → 太弱，远程怪物可绕过

**影响范围**：
- `SilentOathEffect` 需判定伤害来源类型
- 需正确识别"敌对生物"（含被激怒的中立生物）

---

## ADR-009: 胸甲采用 Mixin 单点入口

**日期**：2025-02-04

**决策**：胸甲效果使用 Mixin 直接挂载到原版方法，而非 Fabric API 事件

**原因**：
- 更精确控制触发时机
- 避免事件优先级冲突
- 某些效果（如 Debuff 免疫）只能通过 Mixin 实现
- 项目已有 Mixin 基础设施

**备选方案**：
- Fabric API 事件 → 部分效果无对应事件（如交易完成）
- 混合使用 → 增加复杂度

**影响范围**：
- 所有胸甲效果实现
- 需维护 Mixin 入口清单

**Mixin 入口清单**：
| 效果 | 入口 |
|------|------|
| 交易经验 | `TradeOutputSlot#onTakeItem` |
| 击杀经验 | `LivingEntity#dropXp` |
| 受击储能 | `LivingEntity#damage` |
| 攻击结算 | `PlayerEntity#attack` |
| 亡灵减伤 | `LivingEntity#damage` |
| Debuff免疫 | `LivingEntity#addStatusEffect` |
| 真伤触发 | `PlayerEntity#attack` |

---

## ADR-010: 流血契约储能在同一次 damage 中完成扣血

**日期**：2025-02-04

**决策**：储能触发时，直接修改本次伤害的 amount（加上额外扣血），而非单独调用 damage()

**原因**：
- 避免递归触发 damage 导致无限循环
- 保持伤害计算的原子性
- 日志更清晰（一次伤害事件包含原始+额外）

**备选方案**：
- 单独调用 `player.damage(source, extra)` → 会递归触发 Mixin，需加 flag 判断
- 延迟到下一 tick → 体验不连贯

**影响范围**：
- `BloodPactEffect` 实现
- damage Mixin 需修改返回的 amount

---

## ADR-011: 商人防风衣击退抗性使用 0.3 而非 1.0

**日期**：2025-02-04

**决策**：击退抗性设为 +0.3（30%），而非用户最初设计的 +1.0

**原因**：
- 原版击退抗性属性范围是 0~1，+1.0 = 完全免疫击退
- 完全免疫击退过于强力，破坏战斗节奏
- 0.3 提供明显感知但不破坏平衡

**备选方案**：
- +1.0 → 太强，破坏平衡
- +0.1 → 太弱，感知不明显

**影响范围**：
- `WindbreakerChestplate` 的 AttributeModifier 配置
- 数值后续可根据测试微调

---

## ADR-012: 旧市护甲交易经验仅首次该交易槽触发

**日期**：2025-02-04

**决策**：同一商人的同一交易槽只触发一次加成，防止刷经验

**原因**：
- 防止玩家反复刷同一交易获取大量经验
- 增加策略性：玩家需要寻找不同商人/交易
- 保持经济平衡

**备选方案**：
- 无限制 → 可被滥用刷经验
- 仅 CD 限制 → 等 CD 后仍可重复刷

**影响范围**：
- 需维护已触发交易的记录（key: playerUUID + merchantUUID + tradeIndex）
- 记录需在某些条件下清除（如商人刷新/消失）

---

## ADR-013: 鬼神之铠 Debuff 免疫通过拦截 addStatusEffect 实现

**日期**：2025-02-04

**决策**：在 `addStatusEffect` 入口直接拦截，而非在 tick 中清除

**原因**：
- 更干净，效果根本不会被添加
- 避免短暂出现效果图标又消失的闪烁
- 减少 tick 中的状态检查开销

**备选方案**：
- tick 中定期清除 → 会有短暂的效果显示/影响
- 监听效果事件 → Fabric 无直接的"效果即将添加"事件

**影响范围**：
- 需要 Mixin 到 `LivingEntity#addStatusEffect`
- 需正确判断效果来源是否为亡灵
